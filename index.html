<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Tracker Power-Up</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f5f7;
            color: #172b4d;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #dfe1e6;
        }
        
        .title {
            font-size: 24px;
            font-weight: 600;
            color: #172b4d;
            margin: 0;
        }
        
        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dfe1e6;
        }
        
        .activity-type-filter {
            grid-column: 1 / -1;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #dfe1e6;
        }
        
        .activity-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }
        
        .activity-type-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .activity-type-item:hover {
            border-color: #0079bf;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .activity-type-item.active {
            border-color: #0079bf;
            background: #e4f0f6;
        }
        
        .activity-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #0079bf;
        }
        
        .activity-type-label {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .activity-type-icon {
            font-size: 16px;
        }
        
        .filter-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: #f4f5f7;
            color: #5e6c84;
            border: 1px solid #dfe1e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: #e4f0f6;
            border-color: #0079bf;
            color: #0079bf;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-weight: 500;
            margin-bottom: 6px;
            color: #5e6c84;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #dfe1e6;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #0079bf;
        }
        
        .btn {
            padding: 10px 20px;
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            align-self: end;
        }
        
        .btn:hover {
            background: #005a8b;
        }
        
        .btn:disabled {
            background: #dfe1e6;
            cursor: not-allowed;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #0079bf, #005a8b);
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .activities {
            margin-top: 24px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 8px;
            transition: box-shadow 0.2s;
        }
        
        .activity-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex-grow: 1;
        }
        
        .activity-text {
            font-size: 14px;
            line-height: 1.4;
            margin: 0 0 4px 0;
        }
        
        .activity-meta {
            font-size: 12px;
            color: #5e6c84;
            display: flex;
            gap: 16px;
        }
        
        .activity-board {
            font-weight: 500;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #5e6c84;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5e6c84;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .type-card { background: #61bd4f; }
        .type-comment { background: #f2d600; }
        .type-attachment { background: #ff9f1a; }
        .type-checklist { background: #c377e0; }
        .type-member { background: #0079bf; }
        .type-label { background: #eb5a46; }
        .type-other { background: #838c91; }
        
        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .activity-types {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">📊 Activity Tracker</h1>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Start Date</label>
                <input type="date" id="startDate" />
            </div>
            
            <div class="filter-group">
                <label class="filter-label">End Date</label>
                <input type="date" id="endDate" />
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Board Filter</label>
                <select id="boardFilter">
                    <option value="">All Boards</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label"></label>
                <button class="btn" id="loadActivities">Load Activities</button>
            </div>
            
            <div class="activity-type-filter">
                <div class="filter-label">Activity Types</div>
                <div class="activity-types" id="activityTypes">
                    <!-- Activity type checkboxes will be populated here -->
                </div>
                <div class="filter-controls">
                    <button class="filter-btn" id="selectAll">Select All</button>
                    <button class="filter-btn" id="selectNone">Select None</button>
                    <button class="filter-btn" id="selectCommon">Common Only</button>
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <span class="stat-number" id="totalActivities">0</span>
                <span class="stat-label">Total Activities</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="cardActivities">0</span>
                <span class="stat-label">Card Actions</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="commentActivities">0</span>
                <span class="stat-label">Comments</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="boardsAffected">0</span>
                <span class="stat-label">Boards</span>
            </div>
        </div>
        
        <div class="activities">
            <div id="activityList">
                <div class="empty-state">
                    <div class="empty-icon">📅</div>
                    <h3>Select a date range to view your activity</h3>
                    <p>Choose start and end dates above to see your Trello activity for that period.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // POWER-UP INITIALIZATION - This must run first and fast
        console.log('🚀 Starting Power-Up initialization...');
        
        // Immediately initialize the Power-Up if TrelloPowerUp is available
        if (typeof window.TrelloPowerUp !== 'undefined') {
            console.log('✅ TrelloPowerUp available, initializing immediately');
            initializePowerUp();
        } else {
            console.log('⏳ TrelloPowerUp not ready, waiting...');
            // Try multiple times quickly
            let attempts = 0;
            const maxAttempts = 50;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof window.TrelloPowerUp !== 'undefined') {
                    console.log('✅ TrelloPowerUp ready after', attempts, 'attempts');
                    clearInterval(checkInterval);
                    initializePowerUp();
                } else if (attempts >= maxAttempts) {
                    console.error('❌ TrelloPowerUp failed to load after', maxAttempts, 'attempts');
                    clearInterval(checkInterval);
                }
            }, 100);
        }
        
        function initializePowerUp() {
            try {
                console.log('🔧 Initializing Power-Up capabilities...');
                
                window.TrelloPowerUp.initialize({
                    'board-buttons': function(t, opts) {
                        console.log('🎯 Board buttons capability called');
                        return [{
                            icon: {
                                dark: 'https://cdn.glitch.com/1b42d7fe-bda8-4af8-a6c8-eff0cea9e08a%2Ftrello-power-up-icon%402x.png?1494946157511',
                                light: 'https://cdn.glitch.com/1b42d7fe-bda8-4af8-a6c8-eff0cea9e08a%2Ftrello-power-up-icon%402x.png?1494946157511'
                            },
                            text: 'Activity Tracker',
                            callback: function(t) {
                                console.log('🚀 Board button clicked');
                                console.log('🚀 Opening overlay...');
                                return t.overlay({
                                    url: 'https://brett-pnc.github.io/Trello-Activity-Tracker/',
                                    args: { source: 'board-button' }
                                }).then(function() {
                                    console.log('✅ Overlay opened successfully');
                                }).catch(function(error) {
                                    console.error('❌ Overlay failed to open:', error);
                                });
                            }
                        }];
                    },
                    
                    'card-buttons': function(t, opts) {
                        console.log('🎯 Card buttons capability called');
                        return [{
                            icon: {
                                dark: 'https://cdn.glitch.com/1b42d7fe-bda8-4af8-a6c8-eff0cea9e08a%2Ftrello-power-up-icon%402x.png?1494946157511',
                                light: 'https://cdn.glitch.com/1b42d7fe-bda8-4af8-a6c8-eff0cea9e08a%2Ftrello-power-up-icon%402x.png?1494946157511'
                            },
                            text: 'Activity Tracker',
                            callback: function(t) {
                                console.log('🚀 Card button clicked');
                                return t.overlay({
                                    url: 'https://brett-pnc.github.io/Trello-Activity-Tracker/',
                                    args: { source: 'card-button' }
                                });
                            }
                        }];
                    },
                    
                    'show-settings': function(t, options) {
                        console.log('🎯 Show settings called');
                        return t.popup({
                            title: 'Activity Tracker Settings',
                            url: 'https://brett-pnc.github.io/Trello-Activity-Tracker/?settings=true'
                        });
                    }
                });
                
                console.log('✅ Power-Up initialized successfully!');
                
            } catch (error) {
                console.error('❌ Power-Up initialization error:', error);
            }
        }
        
        // MAIN APPLICATION CODE - Only runs for direct access
        if (window.parent === window) {
            console.log('🔧 Direct access detected, initializing main application...');
            initializeMainApp();
        } else {
            console.log('🔧 Running in iframe context, Power-Up mode');
        }
        
        function initializeMainApp() {
            const TRELLO_API_KEY = 'caeeec29db6d299bd3b65e9743854d5d';
            
            // Activity type configuration
            const activityTypes = {
                createCard: { icon: '📋', name: 'Card Created', class: 'type-card', common: true },
                updateCard: { icon: '✏️', name: 'Card Updated', class: 'type-card', common: true },
                commentCard: { icon: '💬', name: 'Comment Added', class: 'type-comment', common: true },
                addAttachmentToCard: { icon: '📎', name: 'Attachment Added', class: 'type-attachment', common: false },
                addChecklistToCard: { icon: '☑️', name: 'Checklist Added', class: 'type-checklist', common: false },
                addMemberToCard: { icon: '👤', name: 'Member Added', class: 'type-member', common: false },
                addLabelToCard: { icon: '🏷️', name: 'Label Added', class: 'type-label', common: false },
                moveCard: { icon: '↔️', name: 'Card Moved', class: 'type-card', common: true },
                deleteCard: { icon: '🗑️', name: 'Card Deleted', class: 'type-card', common: false },
                removeLabelFromCard: { icon: '🏷️', name: 'Label Removed', class: 'type-label', common: false },
                removeMemberFromCard: { icon: '👤', name: 'Member Removed', class: 'type-member', common: false },
                updateCheckItemStateOnCard: { icon: '✅', name: 'Checklist Item Updated', class: 'type-checklist', common: false },
                createList: { icon: '📝', name: 'List Created', class: 'type-other', common: false },
                updateList: { icon: '📝', name: 'List Updated', class: 'type-other', common: false },
                moveListFromBoard: { icon: '📝', name: 'List Moved', class: 'type-other', common: false },
                copyCard: { icon: '📄', name: 'Card Copied', class: 'type-card', common: false },
                convertToCardFromCheckItem: { icon: '🔄', name: 'Checklist Item to Card', class: 'type-card', common: false },
                addToOrganizationBoard: { icon: '🏢', name: 'Added to Organization', class: 'type-other', common: false },
                removeFromOrganizationBoard: { icon: '🏢', name: 'Removed from Organization', class: 'type-other', common: false },
                updateBoard: { icon: '📊', name: 'Board Updated', class: 'type-other', common: false },
                default: { icon: '⚡', name: 'Other Activity', class: 'type-other', common: false }
            };
            
            let allBoards = [];
            let currentActivities = [];
            let selectedActivityTypes = new Set();
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            async function init() {
                console.log('🔧 Initializing main interface...');
                
                // Set default dates (last 7 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 7);
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                
                // Validate date range on change
                document.getElementById('startDate').addEventListener('change', validateDateRange);
                document.getElementById('endDate').addEventListener('change', validateDateRange);
                
                // Load boards and initialize filters
                await loadBoards();
                initializeActivityTypeFilter();
                
                // Set up event listeners
                document.getElementById('loadActivities').addEventListener('click', loadActivities);
                
                // Load initial activities
                await loadActivities();
            }
            
            function validateDateRange() {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
                
                if (daysDiff > 31) {
                    alert('Date range cannot exceed 31 days');
                    const newEndDate = new Date(startDate);
                    newEndDate.setDate(startDate.getDate() + 31);
                    document.getElementById('endDate').value = newEndDate.toISOString().split('T')[0];
                }
                
                if (startDate > endDate) {
                    document.getElementById('endDate').value = document.getElementById('startDate').value;
                }
            }
            
            async function loadBoards() {
                try {
                    // For direct access, we'll need a different approach to get boards
                    // This is a placeholder - in a real Power-Up context, we'd use t.member('me')
                    const boardFilter = document.getElementById('boardFilter');
                    boardFilter.innerHTML = '<option value="">All Boards</option>';
                    
                    console.log('🔧 Board loading would require Trello context');
                } catch (error) {
                    console.error('Error loading boards:', error);
                }
            }
            
            function initializeActivityTypeFilter() {
                const activityTypesContainer = document.getElementById('activityTypes');
                
                // Create checkboxes for each activity type
                Object.entries(activityTypes).forEach(([type, config]) => {
                    if (type === 'default') return; // Skip default type
                    
                    const item = document.createElement('div');
                    item.className = 'activity-type-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'activity-checkbox';
                    checkbox.id = `type-${type}`;
                    checkbox.checked = config.common; // Default to checked for common types
                    checkbox.addEventListener('change', () => {
                        updateActivityTypeSelection();
                        item.classList.toggle('active', checkbox.checked);
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = `type-${type}`;
                    label.className = 'activity-type-label';
                    label.innerHTML = `
                        <span class="activity-type-icon">${config.icon}</span>
                        ${config.name}
                    `;
                    
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    activityTypesContainer.appendChild(item);
                    
                    // Set initial state
                    if (config.common) {
                        selectedActivityTypes.add(type);
                        item.classList.add('active');
                    }
                    
                    // Make the whole item clickable
                    item.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                });
                
                // Set up filter control buttons
                document.getElementById('selectAll').addEventListener('click', () => {
                    document.querySelectorAll('.activity-checkbox').forEach(cb => {
                        cb.checked = true;
                        cb.dispatchEvent(new Event('change'));
                    });
                });
                
                document.getElementById('selectNone').addEventListener('click', () => {
                    document.querySelectorAll('.activity-checkbox').forEach(cb => {
                        cb.checked = false;
                        cb.dispatchEvent(new Event('change'));
                    });
                });
                
                document.getElementById('selectCommon').addEventListener('click', () => {
                    document.querySelectorAll('.activity-checkbox').forEach(cb => {
                        const type = cb.id.replace('type-', '');
                        const shouldCheck = activityTypes[type]?.common || false;
                        cb.checked = shouldCheck;
                        cb.dispatchEvent(new Event('change'));
                    });
                });
            }
            
            function updateActivityTypeSelection() {
                selectedActivityTypes.clear();
                document.querySelectorAll('.activity-checkbox:checked').forEach(cb => {
                    const type = cb.id.replace('type-', '');
                    selectedActivityTypes.add(type);
                });
                
                // If activities are already loaded, filter them
                if (currentActivities.length > 0) {
                    filterAndDisplayActivities();
                }
            }
            
            function filterAndDisplayActivities() {
                if (selectedActivityTypes.size === 0) {
                    displayActivities([]);
                    updateStats([]);
                    return;
                }
                
                const filteredActivities = currentActivities.filter(activity => {
                    return selectedActivityTypes.has(activity.type);
                });
                
                displayActivities(filteredActivities);
                updateStats(filteredActivities);
            }
            
            async function loadActivities() {
                const loadBtn = document.getElementById('loadActivities');
                const activityList = document.getElementById('activityList');
                const statsDiv = document.getElementById('stats');
                
                loadBtn.disabled = true;
                loadBtn.textContent = 'Loading...';
                
                activityList.innerHTML = '<div class="loading">🔄 Loading activities...</div>';
                statsDiv.style.display = 'none';
                
                try {
                    // For direct access, show a message that Trello context is needed
                    activityList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🔗</div>
                            <h3>Trello Integration Required</h3>
                            <p>This Power-Up needs to be accessed through Trello to load your activity data.</p>
                            <p>Install it as a Power-Up on your Trello board to see your activities!</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading activities:', error);
                    activityList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <h3>Error loading activities</h3>
                            <p>There was an error loading your Trello activities. Please try again.</p>
                        </div>
                    `;
                } finally {
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'Load Activities';
                }
            }
            
            function displayActivities(activities) {
                // Implementation would go here for displaying activities
            }
            
            function updateStats(activities) {
                // Implementation would go here for updating stats
            }
        }
    </script>
</body>
</html>